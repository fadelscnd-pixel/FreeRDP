name: RDP-ZeroTier

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          sc start TermService

      - name: Create RDP User (net user)
        run: |
          net user RDP Rdp12345! /add
          net localgroup administrators RDP /add
          net localgroup "Remote Desktop Users" RDP /add

      - name: Install ZeroTier
        run: |
          curl -L https://download.zerotier.com/dist/ZeroTier%20One.msi -o zt.msi
          msiexec /i zt.msi /quiet /norestart

      - name: Join ZeroTier Network
        run: |
          "C:\Program Files\ZeroTier\One\zerotier-cli.bat" join ${{ secrets.ZEROTIER_NETWORK_ID }}
          timeout /t 20
          "C:\Program Files\ZeroTier\One\zerotier-cli.bat" listnetworks

      - name: Info
        run: |
          echo =====================
          echo USER: RDP
          echo PASS: Rdp12345!
          echo =====================

      - name: Keep Alive
        run: |
          timeout /t 3600
